x-mautic-common: &mautic-common
  image: 'ghcr.io/emmanueljet-limited/mautic-redis:latest'
  volumes:
    - mautic_data_config:/var/www/html/config:z
    - mautic_data_logs:/var/www/html/var/logs:z
    - mautic_data_media_files:/var/www/html/docroot/media/files:z
    - mautic_data_media_images:/var/www/html/docroot/media/images:z
    - mautic_data_plugins:/var/www/html/docroot/plugins:z
    - mautic_data_cron:/opt/mautic/cron:z

x-env-common: &env-common
  MAUTIC_DB_HOST: mariadb
  MAUTIC_DB_USER: mautic
  MAUTIC_DB_PASSWORD: secret
  MAUTIC_DB_NAME: mautic
  MAUTIC_MESSENGER_DSN_EMAIL: redis://redis:6379/0
  MAUTIC_MESSENGER_DSN_HIT: redis://redis:6379/1
  MAUTIC_MESSENGER_DSN_FAILED: redis://redis:6379/2

x-worker-common: &worker-common
  depends_on:
    mautic_web:
      condition: service_healthy
  healthcheck:
    test:
      - CMD-SHELL
      - 'exit 0'
    interval: 5s
    timeout: 10s
    retries: 15

services:
  redis:
    image: redis:7-alpine
    restart: always
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - redis_data:/data
  
  mautic_web:
    <<: *mautic-common
    container_name: mautic-web
    restart: always
    environment:
      <<: *env-common
      DOCKER_MAUTIC_LOAD_TEST_DATA: 'false'
    healthcheck:
      test:
        - CMD-SHELL
        - 'curl -f http://localhost/favicon.ico || exit 1'
      interval: 15s
      timeout: 10s
      retries: 15
    depends_on:
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
  
  mautic_cron:
    <<: [*mautic-common, *worker-common]
    environment:
      <<: *env-common
      DOCKER_MAUTIC_ROLE: mautic_cron
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
  
  mautic_worker:
    <<: [*mautic-common, *worker-common]
    environment:
      <<: *env-common
      DOCKER_MAUTIC_ROLE: mautic_worker
    command: ["php", "bin/console", "messenger:consume", "email", "hit", "failed", "--time-limit=3600", "--memory-limit=1G"]
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

volumes:
  redis_data:
  mautic_data_bin:
  mautic_data_logs:
  mautic_data_cron:
  mautic_data_config:
  mautic_data_vendor:
  mautic_data_plugins:
  mautic_data_media_files:
  mautic_data_media_images: